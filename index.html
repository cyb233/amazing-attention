<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amazing Attention</title>
  <script src="https://cdn.jsdelivr.net/gh/kirakiray/ofa.js/dist/ofa.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/kirakiray/ofa.js/libs/scsr/dist/scsr.min.js"></script>
  <script src="https://unpkg.com/mathjs"></script>
  <script src="https://unpkg.com/d3-regression@1.3.10/dist/d3-regression.min.js"></script>
  <script src="https://unpkg.com/fraction.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js"></script>
  <link rel="stylesheet" href="./public.css">
</head>
<body>
  <o-app>
    <template page>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/balloon-css@1.2.0/balloon.min.css">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css">
      <link rel="stylesheet" href="./public.css">
      <div style="min-height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 20px 10px; box-sizing: border-box;">
        <header>
          <h1>我去，兄弟你真的是<span style="color: red; font-weight: bold;">注意力惊人</span>啊！</h1>
        </header>
        <main>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <button on:click="toggleManualIndex">{{ manualIndex ? '关闭' : '开启' }}手动指定数列位置</button>
            <h2>你是说你看到有一个<span style="color: red; font-weight: bold;">规律数列</span>为</h2>
            <div>
              <x-if :value="manualIndex">
                <label for="sequence">数列</label>
              </x-if>
              <input name="sequence" placeholder="1, 3, 5, 2, 4, ?" sync:value="sequence" required />
              <button aria-label="逗号分隔数字项，未填项填充问号，当未填项为最后一个时可省略" data-balloon-pos="left" data-balloon-length="medium" class="tooltip">？</button>
            </div>
            <x-if :value="manualIndex">
              <div>
                <label for="sequenceIndex">位置</label>
                <input name="sequenceIndex" placeholder="1, 2, 3, 4, 5, 6" sync:value="sequenceIndex" required />
                <button aria-label="填写对应位置，逗号分隔，需填写问号的位置（如有）" data-balloon-pos="left" data-balloon-length="medium" class="tooltip">？</button>
              </div>
            </x-if>
            <h2>然后你一眼<span style="color: red; font-weight: bold;">注意到</span>未填项是</h2>
            <div>
              <x-if :value="manualIndex">
                <label for="answer">未填项</label>
              </x-if>
              <input name="answer" placeholder="114514" sync:value="answer" required />
              <button aria-label="请输入未填项数字" data-balloon-pos="left" data-balloon-length="medium" class="tooltip">？</button>
            </div>
            <x-if :value="manualIndex">
              <div>
                <label for="answerIndex">位置</label>
                <input name="answerIndex" placeholder="6" sync:value="answerIndex" required />
                <button aria-label="填写对应位置" data-balloon-pos="left" data-balloon-length="medium" class="tooltip">？</button>
              </div>
            </x-if>
          </div>
          <div>
            <h2>然后告诉我<span style="color: red; font-weight: bold;">公式</span>是</h2>
            <textarea name="formula" readonly sync:value="formula" style="width: 100%;resize: none;"
            aria-label="最多只计算到10次方程" data-balloon-pos="left" data-balloon-length="medium" class="tooltip"
            ></textarea>
            <div>R² = {{rSquared.toFixed(6)}}</div>
            <div id="KaTex" style="height: max-content;"></div>
          </div>
          <div>
            <h2>我帮你算了下，居然都是对的，太牛了兄弟</h2>
            <x-fill :value="verification">
              <div>{{$data}}</div>
            </x-fill>
          </div>
        </main>
        <footer>
          <a href="https://github.com/cyb233/amazing-attention"><img src="https://img.shields.io/github/stars/cyb233/amazing-attention.svg?style=social&label=Star&maxAge=0" alt="GitHub stars"></a>
        </footer>
      </div>
      <script>
        export default {
          data: {
            manualIndex: false,
            sequence: '1, 3, 5, 2, 4, ?',
            sequenceIndex: '',
            answer: '114514',
            answerIndex: '',
            realSequence: [],
            formula: '',
            rSquared: 0,
            verification: [],
          },
          watch: {
            sequence(newVal) {
              this.organizeInput(newVal, this.answer);
            },
            answer(newVal) {
              this.organizeInput(this.sequence, newVal);
            },
            sequenceIndex(newVal) {
              this.organizeInput(this.sequence, this.answer);
            },
            answerIndex(newVal) {
              this.organizeInput(this.sequence, this.answer);
            },
          },
          ready() {
                this.debouncedCalculate = this.debounce(this.calculateResult);
          },
          proto: {
            // 防抖
            debounce(func, delay = 1000) {
              let timeout;
              return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
              };
            },
            // 整理输入
            organizeInput(sequence = this.sequence, answer = this.answer) {
              const order = sequence.replace(/，/g, ',').replace(/？/g, '?').split(',').map(s => s.trim());
              const index = this.manualIndex ? this.sequenceIndex.replace(/，/g, ',').split(',').map(s => Number(s.trim())) : [];
              if (Number(answer.trim())) {
                if (order.includes('?')) {
                  const index = order.indexOf('?');
                  order[index] = answer;
                  if (this.manualIndex) {
                    if (order.length === index.length) {
                      index[index] = Number(this.answerIndex.trim());
                    }
                  }
                } else {
                  order.push(answer);
                  if (this.manualIndex) {
                    index.push(Number(this.answerIndex.trim()));
                  }
                }
              }
              if (this.manualIndex && index.length !== order.length) {
                console.error('数列项与下标项数量不匹配！', order, index);
                return;
              }
              this.realSequence = order.map((s, i) => { return { x: this.manualIndex ? index[i] : i + 1, y: Number(s.trim()) } });
              console.log(this.realSequence);
              this.debouncedCalculate();
            },
            // 计算结果
            calculateResult(realSequence = this.realSequence) {
              if (realSequence.length === 0 || realSequence.some(r => isNaN(r.y))) return;

              let order = 0;
              let model
              while (true) {
                // 构造回归器
                const regression = d3.regressionPoly()
                  .x(d => d.x)
                  .y(d => d.y)
                  .order(order);
                // 计算结果
                model = regression(realSequence);
                console.log(order, model.rSquared);
                this.rSquared = model.rSquared;
                // R²=1 或 达到10次方程时停止
                if (model.rSquared === 1) break;
                order++;
                if (order > 10) break;
              }
              const coeffs = model.coefficients; // 浮点数系数，降幂排列
              const fracCoeffs = coeffs.map(c => new Fraction(c).toFraction(false)).reverse(); // 分数形式系数，升幂排列
              console.log('拟合系数(浮点):', coeffs);
              console.log('拟合系数(分数):', fracCoeffs);

              // 构造 f(x) 字符串（分数形式）
              let fxStr = "f(x) = ";
              fracCoeffs.forEach((coeff, i) => {
                const power = order - i;
                if (coeff === "0" || coeff === "-0") return;
                if (i > 0 && !coeff.startsWith("-")) fxStr += " + ";
                fxStr += coeff;
                if (power > 0) {
                  fxStr += "*x";
                  if (power > 1) fxStr += "^" + power;
                }
              });

              console.log(fxStr);

              this.formula = fxStr;
              console.log('最终拟合结果:', model, realSequence);
              this.verification = realSequence.map(r => {
                return `f(${r.x}) = ${model.predict(r.x).toFixed()}`
              });

              const tex = math.parse(fxStr).toTex({ notation: 'fixed' });
              console.log(tex);
              katex.render(tex, this.shadow.$('#KaTex').ele);
            },
            toggleManualIndex() {
              this.manualIndex = !this.manualIndex;
              if (!this.manualIndex) {
                this.sequenceIndex = '';
                this.answerIndex = '';
              }
            }
          },
        };
      </script>
    </template>
  </o-app>
</body>
</html>